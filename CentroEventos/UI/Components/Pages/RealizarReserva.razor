@page "/RealizarReserva/{EventoId:int}"
@rendermode InteractiveServer

@using Aplicacion.entidades
@using Aplicacion.UseCases
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Web

@inject NavigationManager Navigation
@inject AltaReserva AltaReserva
@inject IRepositorioEventoDeportivo ServicioEvento
@inject IRepositorioPersona ServicioPersona
@inject IRepositorioReserva ServicioReserva

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-plus"></i> Realizar Reserva
                    </h4>
                </div>
                
                @if (evento != null)
                {
                    <div class="card-body">
                        <!-- Información del evento -->
                        <div class="alert alert-info">
                            <h5><strong>@evento._nombre</strong></h5>
                            <p class="mb-1"><strong>Descripción:</strong> @evento._descripcion</p>
                            <p class="mb-1"><strong>Fecha:</strong> @evento._fechaHoraInicio.ToString("dd/MM/yyyy HH:mm")</p>
                            <p class="mb-1"><strong>Duración:</strong> @evento._duracionHoras horas</p>
                            <p class="mb-0"><strong>Cupo disponible:</strong> @GetCupoDisponible() / @evento._cupoMaximo</p>
                        </div>

                        <!-- Formulario de reserva -->
                        <EditForm Model="@nuevaReserva" OnValidSubmit="@CrearReserva" FormName="reservaForm">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="mb-3">
                                <label for="dni" class="form-label">DNI de la Persona:</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="dni"
                                       @bind="dniPersona" 
                                       placeholder="Ingrese el DNI"
                                       required />
                                <div class="form-text">
                                    Ingrese el DNI de la persona que realizará la reserva.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="fechaAlta" class="form-label">Fecha de Alta:</label>
                                <input type="datetime-local" 
                                       class="form-control" 
                                       id="fechaAlta"
                                       @bind="fechaAltaReserva"
                                       @bind:format="yyyy-MM-ddTHH:mm"
                                       readonly />
                                <div class="form-text">
                                    Fecha y hora actual (generada automáticamente).
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="asistencia" class="form-label">Estado de Asistencia:</label>
                                <select class="form-control" id="asistencia" @bind="estadoAsistencia" disabled>
                                    <option value="Pendiente">Pendiente</option>
                                </select>
                                <div class="form-text">
                                    El estado inicial siempre es "Pendiente".
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" @onclick="Volver">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </button>
                                <button type="submit" class="btn btn-success" disabled="@(!PuedeReservar())">
                                    <i class="fas fa-save"></i> Crear Reserva
                                </button>
                            </div>
                        </EditForm>

                        @if (!string.IsNullOrEmpty(mensajeError))
                        {
                            <div class="alert alert-danger mt-3">
                                <i class="fas fa-exclamation-triangle"></i> @mensajeError
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(mensajeExito))
                        {
                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle"></i> @mensajeExito
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            No se pudo cargar la información del evento.
                        </div>
                        <button class="btn btn-secondary" @onclick="Volver">
                            <i class="fas fa-arrow-left"></i> Volver
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int EventoId { get; set; }

    private EventoDeportivo? evento;
    private Reserva nuevaReserva = new();
    
    // Campos del formulario
    private string dniPersona = string.Empty;
    private DateTime fechaAltaReserva = DateTime.Now;
    private Asistencia estadoAsistencia = Asistencia.Pendiente;
    
    // Mensajes
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarEvento();
        
        // Inicializar fecha actual
        fechaAltaReserva = DateTime.Now;
        estadoAsistencia = Asistencia.Pendiente;
    }

    private async Task CargarEvento()
    {
        try
        {
            evento = await ServicioEvento.ObtenerPorIdAsync(EventoId);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar el evento: {ex.Message}";
            Console.WriteLine($"Error cargando evento: {ex.Message}");
        }
    }

    private async Task CrearReserva()
    {
        try
        {
            // Limpiar mensajes anteriores
            mensajeError = string.Empty;
            mensajeExito = string.Empty;

            // Validar DNI
            if (string.IsNullOrWhiteSpace(dniPersona))
            {
                mensajeError = "Debe ingresar un DNI válido.";
                return;
            }

            // Buscar persona por DNI
            int personaId = ServicioPersona.getIdConDocumento(dniPersona);
            if (personaId == -1)
            {
                mensajeError = $"No se encontró una persona con DNI: {dniPersona}";
                return;
            }

            // Verificar si ya tiene reserva para este evento
            if (await YaTieneReserva(personaId))
            {
                mensajeError = "Esta persona ya tiene una reserva para este evento.";
                return;
            }

            // Crear la reserva
            var reserva = new Reserva(
                personaId,
                EventoId
            );

            // Guardar usando caso de uso
            AltaReserva.Ejecutar(personaId, EventoId);

            mensajeExito = "¡Reserva creada exitosamente!";
            
            // Limpiar formulario
            dniPersona = string.Empty;
            fechaAltaReserva = DateTime.Now;
            
            StateHasChanged();

            // Opcional: Redireccionar después de un delay
            await Task.Delay(2000);
            Volver();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al crear la reserva: {ex.Message}";
            Console.WriteLine($"Error creando reserva: {ex.Message}");
        }
    }

    private async Task<bool> YaTieneReserva(int personaId)
    {
        try
        {
            // Aquí deberías implementar la lógica para verificar si ya tiene reserva
            // Por ejemplo, usando un método en el repositorio de reservas
            // return await ServicioReserva.ExisteReservaAsync(personaId, EventoId);
            return false; // Temporal
        }
        catch (Exception)
        {
            return false;
        }
    }

    private bool PuedeReservar()
    {
        return !string.IsNullOrWhiteSpace(dniPersona) && 
               evento != null && 
               GetCupoDisponible() > 0;
    }

    private int GetCupoDisponible()
    {
        if (evento == null) return 0;
        
        // Aquí deberías calcular el cupo real basado en las reservas existentes
        // Por ahora retornamos el cupo máximo
        return evento._cupoMaximo; // Temporal
    }

    private void Volver()
    {
        Navigation.NavigateTo("/GestionEventoDeportivo");
    }
}